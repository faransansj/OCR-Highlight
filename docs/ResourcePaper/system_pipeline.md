# ì‹œìŠ¤í…œ íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜ (System Pipeline Architecture)

## ğŸ—ï¸ ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì¡°

### 3ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INPUT: Document Image                      â”‚
â”‚                    (PNG, JPG, 800Ã—600)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 STAGE 1: Highlight Detection                  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ RGB â†’ HSV    â”‚ -> â”‚ Color Mask   â”‚ -> â”‚ Morphology   â”‚   â”‚
â”‚  â”‚ Conversion   â”‚    â”‚ Thresholding â”‚    â”‚ Operations   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Contour      â”‚ -> â”‚ Bounding Box â”‚                        â”‚
â”‚  â”‚ Detection    â”‚    â”‚ Extraction   â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                â”‚
â”‚  Output: List of {bbox, color} for each highlight             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STAGE 2: Text Extraction (OCR)               â”‚
â”‚                                                                â”‚
â”‚  For each detected highlight region:                          â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Region       â”‚ -> â”‚ Tesseract    â”‚ -> â”‚ Confidence   â”‚   â”‚
â”‚  â”‚ Cropping     â”‚    â”‚ OCR (LSTM)   â”‚    â”‚ Evaluation   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚ Multi-PSM    â”‚  (if confidence < 70%)                      â”‚
â”‚  â”‚ Fallback     â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                â”‚
â”‚  Output: {text, confidence} for each region                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STAGE 3: Post-processing                     â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 1. Korean Space Removal (Recursive)                 â”‚      â”‚
â”‚  â”‚    - Remove spaces between Korean characters        â”‚      â”‚
â”‚  â”‚    - Remove spaces before particles                 â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 2. Duplicate Text Removal                           â”‚      â”‚
â”‚  â”‚    - Pattern: "í•­ìŠµì„í•™ìŠµì„" â†’ "í•™ìŠµì„"             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 3. Korean Particle Restoration                      â”‚      â”‚
â”‚  â”‚    - Fix: "OpenCVE" â†’ "OpenCVëŠ”"                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 4. Character Substitution Fixes                     â”‚      â”‚
â”‚  â”‚    - "OpencV" â†’ "OpenCV"                            â”‚      â”‚
â”‚  â”‚    - "Opencv" â†’ "OpenCV"                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 5. Noise Removal                                    â”‚      â”‚
â”‚  â”‚    - Trailing junk: "í•™ìŠµì„ TSS" â†’ "í•™ìŠµì„"        â”‚      â”‚
â”‚  â”‚    - Over-segmentation cleanup                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                â”‚
â”‚  Output: {text, color, confidence, bbox}                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  OUTPUT: Multiple Formats                     â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  JSON   â”‚  â”‚   CSV   â”‚  â”‚   TXT   â”‚  â”‚  Image  â”‚         â”‚
â”‚  â”‚ Detailedâ”‚  â”‚ Tabular â”‚  â”‚ Summary â”‚  â”‚ Annotateâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Stage 1: í•˜ì´ë¼ì´íŠ¸ ê²€ì¶œ ìƒì„¸ (Highlight Detection)

### 1.1 ìƒ‰ê³µê°„ ë³€í™˜

**RGB â†’ HSV ë³€í™˜**:
```python
hsv_image = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
```

**HSV ìƒ‰ê³µê°„ ì„ íƒ ì´ìœ **:
- Hue(ìƒ‰ìƒ)ê°€ ì¡°ëª… ë³€í™”ì— ê°•ì¸
- Saturation(ì±„ë„)ë¡œ í˜•ê´‘íœ ê°•ë„ êµ¬ë¶„
- Value(ëª…ë„)ë¡œ ë°ê¸° ì¡°ì ˆ

### 1.2 ìƒ‰ìƒ ë§ˆìŠ¤í‚¹

**3ê°€ì§€ ìƒ‰ìƒ ë²”ìœ„**:

| ìƒ‰ìƒ | H (Hue) | S (Saturation) | V (Value) |
|------|---------|----------------|-----------|
| ë…¸ë€ìƒ‰ | 25-35Â° | 60-255 | 70-255 |
| ì´ˆë¡ìƒ‰ | 55-65Â° | 60-255 | 70-255 |
| ë¶„í™ìƒ‰ | 169-180Â° | 10-70 | 70-255 |

**ë§ˆìŠ¤í¬ ìƒì„±**:
```python
lower = np.array([hue_min, sat_min, val_min])
upper = np.array([hue_max, sat_max, val_max])
mask = cv2.inRange(hsv_image, lower, upper)
```

### 1.3 í˜•íƒœí•™ì  í›„ì²˜ë¦¬

**ë‹«í˜ ì—°ì‚° (Closing)**:
```python
kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (5, 5))
mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel, iterations=2)
```

**ëª©ì **:
- ì‘ì€ êµ¬ë© ë©”ìš°ê¸°
- ëŠì–´ì§„ ì˜ì—­ ì—°ê²°
- ë…¸ì´ì¦ˆ ì œê±°

### 1.4 ìœ¤ê³½ì„  ê²€ì¶œ ë° í•„í„°ë§

**ìœ¤ê³½ì„  ì¶”ì¶œ**:
```python
contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
```

**í•„í„°ë§ ì¡°ê±´**:
- ìµœì†Œ ì˜ì—­: 120 í”½ì…€Â²
- ì¢…íš¡ë¹„: 0.2 ~ 20 (ë„ˆë¬´ ê°€ëŠ˜ê±°ë‚˜ ë‘ê»ì§€ ì•ŠìŒ)
- ê²½ê³„ ê±°ë¦¬: ì´ë¯¸ì§€ ê°€ì¥ìë¦¬ì—ì„œ 5í”½ì…€ ì´ìƒ

**ë°”ìš´ë”© ë°•ìŠ¤ ìƒì„±**:
```python
x, y, w, h = cv2.boundingRect(contour)
bbox = {'x': x, 'y': y, 'width': w, 'height': h}
```

### 1.5 ì„±ëŠ¥ ìµœì í™”

| ìµœì í™” ê¸°ë²• | ì„±ëŠ¥ ê°œì„  | ì„¤ëª… |
|-------------|-----------|------|
| ê°€ìš°ì‹œì•ˆ ë¸”ëŸ¬ | +5% IoU | ë…¸ì´ì¦ˆ ì‚¬ì „ ì œê±° |
| íƒ€ì›í˜• ì»¤ë„ | +3% ì •ë°€ë„ | ìì—°ìŠ¤ëŸ¬ìš´ í˜•ê´‘íœ ëª¨ì–‘ |
| 2íšŒ ë°˜ë³µ ë‹«í˜ | +8% ì¬í˜„ìœ¨ | ëŠì–´ì§„ ì˜ì—­ ì—°ê²° |
| ë©´ì  ì„ê³„ê°’ 120 | -12% FP | ì‘ì€ ë…¸ì´ì¦ˆ ì œê±° |

---

## ğŸ” Stage 2: í…ìŠ¤íŠ¸ ì¶”ì¶œ ìƒì„¸ (OCR)

### 2.1 ì˜ì—­ ì „ì²˜ë¦¬

**ROI (Region of Interest) ì¶”ì¶œ**:
```python
roi = image[y:y+h, x:x+w]
```

**ì „ì²˜ë¦¬ ë¹„í™œì„±í™”**:
- ì ì‘í˜• ì´ì§„í™”: âŒ (í•˜ì´ë¼ì´íŠ¸ í…ìŠ¤íŠ¸ í’ˆì§ˆ ì €í•˜)
- ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜: âœ… (Tesseract ì…ë ¥ í˜•ì‹)
- ë…¸ì´ì¦ˆ ì œê±°: âŒ (í˜•ê´‘íœ ìƒ‰ìƒ ì†ì‹¤ ìš°ë ¤)

### 2.2 Tesseract OCR ì„¤ì •

**ìµœì  ì„¤ì •**:
```python
config = {
    'lang': 'kor+eng',      # í•œê¸€+ì˜ë¬¸ í˜¼í•© ëª¨ë“œ
    'oem': 3,               # LSTM ì—”ì§„ (ìµœì‹ )
    'psm': 7,               # ë‹¨ì¼ í…ìŠ¤íŠ¸ ë¼ì¸
    'min_confidence': 60.0  # ì‹ ë¢°ë„ ì„ê³„ê°’
}
```

**PSM (Page Segmentation Mode) ëª¨ë“œ ì„¤ëª…**:

| PSM | ì„¤ëª… | ì í•© ìƒí™© | ë³¸ ì‹œìŠ¤í…œ ì‚¬ìš© |
|-----|------|-----------|----------------|
| 0 | OSDë§Œ | ë°©í–¥ ê²€ì¶œ | âŒ |
| 3 | ì™„ì „ ìë™ | ë‹¤ì¤‘ ì»¬ëŸ¼ | ë³´ì¡° (ì‹ ë¢°ë„ ë‚®ì„ ë•Œ) |
| 6 | ê· ì¼ ë¸”ë¡ | ë‹¨ë½ í…ìŠ¤íŠ¸ | âŒ |
| **7** | **ë‹¨ì¼ ë¼ì¸** | **í•˜ì´ë¼ì´íŠ¸** | **âœ… ì£¼ ëª¨ë“œ** |
| 8 | ë‹¨ì¼ ë‹¨ì–´ | ë‹¨ì–´ í•˜ë‚˜ | ë³´ì¡° |
| 11 | í¬ì†Œ í…ìŠ¤íŠ¸ | ë¶ˆê·œì¹™ ë°°ì¹˜ | ë³´ì¡° |

### 2.3 ë‹¤ì¤‘ PSM ì „ëµ

**ì‹ ë¢°ë„ ê¸°ë°˜ Fallback**:
```python
if avg_confidence < 70%:
    results = []
    for psm in [7, 3, 8, 11]:
        text, conf = run_tesseract(roi, psm=psm)
        results.append((text, conf))

    # ê°€ì¥ ë†’ì€ ì‹ ë¢°ë„ ì„ íƒ
    best_text, best_conf = max(results, key=lambda x: x[1])
```

**íš¨ê³¼**:
- ì €ì‹ ë¢°ë„ ì˜ì—­ ì •í™•ë„ +3%
- ì²˜ë¦¬ ì‹œê°„ +0.15ì´ˆ (ì‹ ë¢°ë„ ë‚®ì„ ë•Œë§Œ)

### 2.4 ì‹ ë¢°ë„ í‰ê°€

**ë¬¸ìë³„ ì‹ ë¢°ë„ ì§‘ê³„**:
```python
confidences = [char_conf for char_conf in tesseract_result]
avg_confidence = sum(confidences) / len(confidences)
```

**ì‹ ë¢°ë„ ë“±ê¸‰**:
- 90-100%: ë§¤ìš° ë†’ìŒ (ìš°ìˆ˜)
- 70-89%: ë†’ìŒ (ì–‘í˜¸)
- 50-69%: ë³´í†µ (ê²€í†  í•„ìš”)
- 25-49%: ë‚®ìŒ (ì¬ì²˜ë¦¬ ê¶Œì¥)
- 0-24%: ë§¤ìš° ë‚®ìŒ (ì‹¤íŒ¨)

---

## âœ¨ Stage 3: í›„ì²˜ë¦¬ ìƒì„¸ (Post-processing)

### 3.1 í•œêµ­ì–´ ê³µë°± ì œê±° (ì¬ê·€ì )

**ì•Œê³ ë¦¬ì¦˜**:
```python
prev_text = None
while prev_text != full_text:
    prev_text = full_text
    # í•œê¸€ ë¬¸ì ê°„ ê³µë°± ì œê±°
    full_text = re.sub(r'([\uac00-\ud7af])\s+([\uac00-\ud7af])', r'\1\2', full_text)
```

**íš¨ê³¼**:
- 75% ì˜¤ë¥˜ ê°ì†Œ (ê°€ì¥ í° ê°œì„ )
- 33ê±´ ê³µë°± ì˜¤ë¥˜ â†’ 2ê±´

**ì˜ˆì‹œ**:
- "ì»´ í“¨ í„°" â†’ "ì»´í“¨í„°"
- "O p e n C V" â†’ "OpenCV" (ì˜ë¬¸ì€ ì œì™¸)

### 3.2 ì¡°ì‚¬ ê³µë°± ì œê±°

**ì•Œê³ ë¦¬ì¦˜**:
```python
# ì¡°ì‚¬ ì• ê³µë°± ì œê±°
full_text = re.sub(
    r'([\uac00-\ud7af])\s+([ì€ëŠ”ì´ê°€ì„ë¥¼ì—ì„œ])\b',
    r'\1\2',
    full_text
)
```

**ëŒ€ìƒ ì¡°ì‚¬**:
- ì£¼ê²©: ì€, ëŠ”, ì´, ê°€
- ëª©ì ê²©: ì„, ë¥¼
- ë¶€ì‚¬ê²©: ì—ì„œ

**ì˜ˆì‹œ**:
- "ì»´í“¨í„° ëŠ”" â†’ "ì»´í“¨í„°ëŠ”"
- "OpenCV ì—ì„œ" â†’ "OpenCVì—ì„œ"

### 3.3 ì¤‘ë³µ í…ìŠ¤íŠ¸ ì œê±°

**ì•Œê³ ë¦¬ì¦˜**:
```python
matches = re.findall(r'([\uac00-\ud7af]{2,}[ì€ë¥¼ì„])', full_text)
for match1 in matches:
    for match2 in matches:
        if match2.endswith(match1) and len(match2) > len(match1):
            full_text = full_text.replace(match2, match1)
```

**ì˜ˆì‹œ**:
- "í•­ìŠµì„í•™ìŠµì„" â†’ "í•™ìŠµì„"
- "ì¸ì‹ì€ì¸ì‹ì€" â†’ "ì¸ì‹ì€"

### 3.4 í•œêµ­ì–´ ì¡°ì‚¬ ë³µì›

**E â†’ ëŠ” ì¹˜í™˜**:
```python
if full_text.endswith('E') and len(full_text) > 1:
    if re.match(r'^[A-Z][A-Za-z]+E$', full_text):
        full_text = full_text[:-1] + 'ëŠ”'
```

**ì›ì¸**:
- Tesseractê°€ í•œê¸€ ì¡°ì‚¬ "ëŠ”"ë¥¼ ì˜ë¬¸ "E"ë¡œ ì˜¤ì¸ì‹

**ì˜ˆì‹œ**:
- "OpenCVE" â†’ "OpenCVëŠ”"
- "TesseractE" â†’ "TesseractëŠ”"

**íš¨ê³¼**: 7ê±´ ì˜¤ë¥˜ ìˆ˜ì •

### 3.5 ë¬¸ì ì¹˜í™˜ ìˆ˜ì •

**ëŒ€ì†Œë¬¸ì ìˆ˜ì •**:
```python
full_text = re.sub(r'Opencv', 'OpenCV', full_text)
full_text = re.sub(r'OpencV', 'OpenCV', full_text)
full_text = re.sub(r'OpencVE', 'OpenCVëŠ”', full_text)
```

**ê³ ë¹ˆë„ ì˜¤ë¥˜ íŒ¨í„´**:
- "Opencv" (ì†Œë¬¸ì ì‹œì‘)
- "OpencV" (c/C í˜¼ë™)
- "OpencVE" (ë³µí•© ì˜¤ë¥˜)

**íš¨ê³¼**: 5ê±´ ì˜¤ë¥˜ ìˆ˜ì •

### 3.6 ë…¸ì´ì¦ˆ ì œê±°

**í›„í–‰ ë…¸ì´ì¦ˆ**:
```python
# "í•™ìŠµì„ TSS" â†’ "í•™ìŠµì„"
full_text = re.sub(
    r'([\uac00-\ud7af]+[ì€ëŠ”ì´ê°€ì„ë¥¼ì—ì„œ]?)\s+[A-Z]{2,}$',
    r'\1',
    full_text
)
```

**ê³¼ë¶„í•  ìˆ˜ì •**:
```python
# "Intersection over Union" â†’ "Intersection"
if full_text.startswith('Intersection') and len(full_text) > len('Intersection'):
    full_text = 'Intersection'
```

**ë…ë¦½ ê¸°í˜¸ ì œê±°**:
```python
full_text = re.sub(r'\s+[|/:;.]+\s*$', '', full_text)
```

---

## ğŸ“¤ ì¶œë ¥ í¬ë§· (Output Formats)

### JSON ì¶œë ¥

**êµ¬ì¡°**:
```json
{
  "image_path": "document.jpg",
  "total_highlights": 4,
  "highlights_by_color": {
    "yellow": 1,
    "green": 2,
    "pink": 1
  },
  "results": [
    {
      "text": "OpenCVëŠ”",
      "color": "pink",
      "confidence": 86.0,
      "bbox": {
        "x": 50,
        "y": 48,
        "width": 96,
        "height": 24
      }
    }
  ]
}
```

**ìš©ë„**: í”„ë¡œê·¸ë˜ë° í†µí•©, API ì‘ë‹µ

### CSV ì¶œë ¥

**êµ¬ì¡°**:
```csv
Color,Text,Confidence,X,Y,Width,Height
pink,OpenCVëŠ”,86.00,50,48,96,24
green,ì»´í“¨í„°,96.00,100,50,60,22
yellow,ë¹„ì „ì„,89.20,150,52,75,20
```

**ìš©ë„**: ë°ì´í„° ë¶„ì„, ì—‘ì…€ í†µí•©

### TXT ìš”ì•½

**êµ¬ì¡°**:
```
======================================================================
HIGHLIGHT TEXT EXTRACTION SUMMARY
======================================================================

Image: document.jpg
Total Highlights: 4

Highlights by Color:
  Yellow: 1
  Green: 2
  Pink: 1

======================================================================
EXTRACTED TEXT BY COLOR
======================================================================

YELLOW HIGHLIGHTS (1):
  1. ë¹„ì „ì„

GREEN HIGHLIGHTS (2):
  1. ì»´í“¨í„°
  2. ì‹¤ì‹œê°„

PINK HIGHLIGHTS (1):
  1. OpenCVëŠ”

======================================================================
DETAILED RESULTS
======================================================================

1. [PINK] "OpenCVëŠ”"
   Confidence: 86.0%
   Location: x=50, y=48, w=96, h=24

2. [GREEN] "ì»´í“¨í„°"
   Confidence: 96.0%
   Location: x=100, y=50, w=60, h=22
```

**ìš©ë„**: ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ ìš”ì•½

### ì‹œê°í™” ì¶œë ¥

**ì£¼ì„ ë‚´ìš©**:
- ë°”ìš´ë”© ë°•ìŠ¤ (ìƒ‰ìƒë³„ êµ¬ë¶„)
- ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ë ˆì´ë¸”
- ì‹ ë¢°ë„ í‘œì‹œ

**ìƒ‰ìƒ ì½”ë“œ**:
- ë…¸ë€ìƒ‰: BGR(0, 255, 255)
- ì´ˆë¡ìƒ‰: BGR(0, 255, 0)
- ë¶„í™ìƒ‰: BGR(255, 105, 180)

---

## ğŸ”§ í•µì‹¬ í´ë˜ìŠ¤ êµ¬ì¡°

### HighlightDetector

```python
class HighlightDetector:
    """í•˜ì´ë¼ì´íŠ¸ ì˜ì—­ ê²€ì¶œ"""

    def __init__(self, config_path: str):
        self.hsv_ranges = load_config(config_path)
        self.min_area = 120
        self.morph_iterations = 2

    def detect(self, image: np.ndarray) -> List[Dict]:
        """ì´ë¯¸ì§€ì—ì„œ í•˜ì´ë¼ì´íŠ¸ ê²€ì¶œ"""
        hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
        detections = []

        for color, ranges in self.hsv_ranges.items():
            mask = self._create_mask(hsv, ranges)
            mask = self._morphology(mask)
            contours = self._find_contours(mask)
            detections.extend(self._filter_contours(contours, color))

        return detections
```

### OCREngine

```python
class OCREngine:
    """OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° í›„ì²˜ë¦¬"""

    def __init__(self, lang='kor+eng', min_confidence=60.0):
        self.lang = lang
        self.config = '--psm 7 --oem 3'
        self.min_confidence = min_confidence
        self.use_multi_psm = True

    def extract_text(self, image: np.ndarray, bbox: Dict,
                     color: str) -> Tuple[str, float]:
        """ì˜ì—­ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ"""
        roi = self._crop_region(image, bbox)
        text, conf = self._run_tesseract(roi)

        if conf < self.min_confidence and self.use_multi_psm:
            text, conf = self._multi_psm_fallback(roi)

        text = self._postprocess(text)
        return text, conf
```

### HighlightTextExtractor

```python
class HighlightTextExtractor:
    """ì—”ë“œíˆ¬ì—”ë“œ íŒŒì´í”„ë¼ì¸"""

    def __init__(self):
        self.highlight_detector = HighlightDetector(config_path)
        self.ocr_engine = OCREngine(lang='kor+eng')

    def process_image(self, image_path: str) -> ExtractionResult:
        """ì´ë¯¸ì§€ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰"""
        image = cv2.imread(image_path)

        # Stage 1: í•˜ì´ë¼ì´íŠ¸ ê²€ì¶œ
        detections = self.highlight_detector.detect(image)

        # Stage 2 & 3: OCR + í›„ì²˜ë¦¬
        results = []
        for det in detections:
            text, conf = self.ocr_engine.extract_text(
                image, det['bbox'], det['color']
            )
            results.append(HighlightTextResult(
                text=text,
                color=det['color'],
                confidence=conf,
                bbox=det['bbox']
            ))

        return ExtractionResult(results, image_path)
```

---

## ğŸ“Š íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ íŠ¹ì„±

### ë³‘ëª© êµ¬ê°„ ë¶„ì„

| ë‹¨ê³„ | ì†Œìš” ì‹œê°„ | ë¹„ìœ¨ | ìµœì í™” ê°€ëŠ¥ì„± |
|------|-----------|------|---------------|
| í•˜ì´ë¼ì´íŠ¸ ê²€ì¶œ | 0.12ì´ˆ | 14.6% | ì¤‘ê°„ (GPU ê°€ì†) |
| **OCR ì¶”ì¶œ** | **0.58ì´ˆ** | **70.7%** | **ë‚®ìŒ** (Tesseract ì˜ì¡´) |
| í›„ì²˜ë¦¬ | 0.04ì´ˆ | 4.9% | ë†’ìŒ (ì´ë¯¸ ìµœì í™”) |
| I/O | 0.08ì´ˆ | 9.8% | ì¤‘ê°„ (SSD í•„ìš”) |

**ê²°ë¡ **: OCR ë‹¨ê³„ê°€ ì£¼ ë³‘ëª©, Tesseract ìµœì í™”ê°€ í•µì‹¬

### í™•ì¥ì„±

| ì´ë¯¸ì§€ ìˆ˜ | ìˆœì°¨ ì²˜ë¦¬ | ë³‘ë ¬ ì²˜ë¦¬ (4ì½”ì–´) | ì†ë„ í–¥ìƒ |
|-----------|-----------|-------------------|-----------|
| 10ê°œ | 8.2ì´ˆ | 2.5ì´ˆ | 3.3Ã— |
| 50ê°œ | 41.0ì´ˆ | 12.1ì´ˆ | 3.4Ã— |
| 100ê°œ | 82.0ì´ˆ | 24.5ì´ˆ | 3.3Ã— |

**ë³‘ë ¬ ì²˜ë¦¬ íš¨ìœ¨**: ì•½ 82% (ì´ìƒì : 100%)

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-19
**ê´€ë ¨ íŒŒì¼**: `src/pipeline.py`, `src/highlight_detector.py`, `src/ocr/ocr_engine.py`
